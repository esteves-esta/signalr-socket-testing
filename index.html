<html>
  <head>
    <title>WEBSOCKET COM SIGNALR</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
    />
    <script>
      window.apiBaseUrl = "http://localhost:7071";
    </script>
    <style>
      .slide-fade-enter-active,
      .slide-fade-leave-active {
        transition: all 1s ease;
      }
      .slide-fade-enter,
      .slide-fade-leave-to {
        height: 0px;
        overflow-y: hidden;
        opacity: 0;
      }

      code {
        color: #444;
      }
    </style>
  </head>

  <body>
    <p>&nbsp;</p>
    <div id="app" class="container">
      <h3>TESTANDO WEBSOCKET COM SIGNALR</h3>

      <div class="row" v-if="!ready">
        <div class="col-sm">
          <div>Carregando...</div>
        </div>
      </div>

      <div class="row" v-if="ready">
        <div class="signalr-demo col">
          <div>
            <p class="text-info small">
              Rota de conexão: <strong>{{ urlConnection }}</strong>
            </p>
            <p class="text-info small">
              Rota para o post: <strong>{{ urlPost }}</strong>
            </p>
          </div>
        </div>
      </div>

      <div class="row" v-if="ready">
        <div class="col">
          <form v-on:submit.prevent="sendNewMessage">
            <textarea
              rows="10"
              type="text"
              v-model="newMessage"
              id="message-box"
              class="form-control"
              placeholder="Escreva aqui o corpo da requisição"
              autocomplete="off"
            >
            </textarea>

            <button class="btn btn-primary btn-lg btn-block" type="submit">
              {{btnText}}
            </button>
          </form>
        </div>

        <div class="col">
          <div v-if="ready">
            <transition-group name="slide-fade" tag="div">
              <div
                class="row"
                v-for="message in messages"
                v-bind:key="message.id"
              >
                <div class="col-sm">
                  <div>
                    <div>
                      <code> {{ message.text }} </code>
                    </div>
                  </div>
                  <hr />
                </div>
              </div>
            </transition-group>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.17/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@aspnet/signalr@1.1.2/dist/browser/signalr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@0.18.0/dist/axios.min.js"></script>

    <script>
      const data = {
        username: "",
        urlConnection: "",
        urlPost: "",
        newMessage: "",
        messages: [],
        ready: false,
        btnText: "MANDAR",
      };

      const app = new Vue({
        el: "#app",
        data: data,
        methods: {
          sendNewMessage: async function () {
            this.btnText = "ENVIANDO...";
            const result = await sendMessage(this.newMessage);
            console.log("resultado da requisição");
            console.log(result);
            this.btnText = result.status === 200 ? "MANDAR" : "MANDAR DENOVO";
            this.newMessage = "";
          },
        },
      });

      const apiBaseUrl = prompt(
        "Enter the Azure Function app base URL",
        window.apiBaseUrl + "/api/web/turnlist"
      );
      const postRoute = prompt(
        "Enter the post route",
        `${window.apiBaseUrl}/api/web/turnlist/onservice`
      );

      data.urlConnection = apiBaseUrl;
      data.urlPost = postRoute;

      const connection = new signalR.HubConnectionBuilder()
        .withUrl(`${apiBaseUrl}`)
        .configureLogging(signalR.LogLevel.Information)
        .build();

      connection.on("listUpdate", (value) => {
        console.log(value);
        newMessage(JSON.stringify(value));
      });

      connection.onclose(() => console.log("disconnected"));

      console.log("connecting...");
      connection
        .start()
        .then(() => (data.ready = true))
        .catch(console.error);

      async function sendMessage(body) {
        const status = await axios.post(postRoute, body);
        return status;
      }

      let counter = 0;
      function newMessage(message) {
        let msg = { text: message };
        msg.id = counter++; // vue transitions need an id
        data.messages.unshift(msg);
      }
    </script>
  </body>
</html>
